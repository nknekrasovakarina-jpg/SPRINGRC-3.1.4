<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin panel</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-dark bg-dark px-3">
    <span class="navbar-text text-white">
        <span id="current-username"></span> with roles:
        <span id="current-roles"></span>
    </span>
    <form action="/logout" method="post">
        <button class="btn btn-outline-light">Logout</button>
    </form>
</nav>

<div class="container-fluid mt-3">

    <h2>Admin panel</h2>

    <div id="alert-container"></div>

    <ul class="nav nav-tabs mt-3">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#users-tab">Users table</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#newuser-tab">New User</button>
        </li>
    </ul>

    <div class="tab-content mt-3">

        <!-- Users -->
        <div class="tab-pane fade show active" id="users-tab">
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>ID</th><th>Username</th><th>Email</th><th>Age</th><th>Roles</th><th>Edit</th><th>Delete</th>
                </tr>
                </thead>
                <tbody id="users-table-body"></tbody>
            </table>
        </div>

        <!-- New User -->
        <div class="tab-pane fade" id="newuser-tab">
            <form id="new-user-form" class="col-4">

                <label>Username</label>
                <input class="form-control mb-2" name="username" required>

                <label>Email</label>
                <input class="form-control mb-2" name="email" required>

                <label>Age</label>
                <input type="number" class="form-control mb-2" name="age">

                <label>Password</label>
                <input type="password" class="form-control mb-2" name="password" required>

                <label>Roles</label>
                <select id="new-user-roles" class="form-select mb-2" multiple></select>

                <button class="btn btn-success w-100">Add new user</button>
            </form>
        </div>

    </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal">
    <div class="modal-dialog">
        <div class="modal-content">

            <form id="edit-user-form">

                <div class="modal-header">
                    <h5>Edit user</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <input type="hidden" id="edit-id">

                    <label>Username</label>
                    <input id="edit-username" class="form-control mb-2">

                    <label>Email</label>
                    <input id="edit-email" class="form-control mb-2">

                    <label>Age</label>
                    <input id="edit-age" type="number" class="form-control mb-2">

                    <label>Password (optional)</label>
                    <input id="edit-password" type="password" class="form-control mb-2">

                    <label>Roles</label>
                    <select id="edit-roles" class="form-select" multiple></select>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button class="btn btn-primary" type="submit">Save</button>
                </div>

            </form>

        </div>
    </div>
</div>

<!-- DELETE MODAL -->
<div class="modal fade" id="deleteModal">
    <div class="modal-dialog">
        <div class="modal-content">

            <form id="delete-user-form">

                <div class="modal-header">
                    <h5>Delete user</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <input type="hidden" id="delete-id">

                    <p><b>ID:</b> <span id="delete-id-show"></span></p>
                    <p><b>Username:</b> <span id="delete-username"></span></p>
                    <p><b>Email:</b> <span id="delete-email"></span></p>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button class="btn btn-danger" type="submit">Delete</button>
                </div>

            </form>

        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const api = "/api/admin/users";

    function showAlert(msg, type="danger") {
        document.getElementById("alert-container").innerHTML =
            `<div class="alert alert-${type}">${msg}</div>`;
    }

    /* -------- LOAD USERS -------- */
    async function loadUsers() {
        let res = await fetch(api);
        let users = await res.json();

        let tbody = document.getElementById("users-table-body");
        tbody.innerHTML = "";

        users.forEach(u => {
            tbody.innerHTML += `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.username}</td>
                    <td>${u.email}</td>
                    <td>${u.age || ""}</td>
                    <td>${u.roles.join(", ")}</td>

                    <td>
                        <button class="btn btn-info btn-sm"
                                onclick='openEdit(${JSON.stringify(u)})'>
                            Edit
                        </button>
                    </td>

                    <td>
                        <button class="btn btn-danger btn-sm"
                                onclick='openDelete(${u.id},"${u.username}","${u.email}")'>
                            Delete
                        </button>
                    </td>
                </tr>`;
        });
    }

    /* -------- NEW USER -------- */
    // ======================= CONFIG =======================
    const API = "/api/admin";


    // ======================= LOAD CURRENT USER (navbar) =======================
    async function loadCurrentUser() {
        try {
            const res = await fetch("/api/user/me");
            if (!res.ok) return;

            const user = await res.json();
            document.getElementById("current-username").innerText = user.username;
            document.getElementById("current-roles").innerText = user.roles.join(', ');
        } catch (e) {
            console.error("Error loading current user:", e);
        }
    }


    // ======================= LOAD ROLES =======================
    async function loadRoles() {
        try {
            const res = await fetch(`${API}/roles`);
            const roles = await res.json();

            const newSelect = document.getElementById("new-user-roles");
            const editSelect = document.getElementById("edit-roles");

            newSelect.innerHTML = "";
            editSelect.innerHTML = "";

            roles.forEach(role => {
                const opt1 = new Option(role, role);
                const opt2 = new Option(role, role);

                newSelect.add(opt1);
                editSelect.add(opt2);
            });
        } catch (e) {
            console.error("Error loading roles:", e);
        }
    }


    // ======================= LOAD ALL USERS =======================
    async function loadUsers() {
        try {
            const res = await fetch(`${API}/users`);
            const users = await res.json();
            const tbody = document.getElementById("users-table-body");

            tbody.innerHTML = "";

            users.forEach(u => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
                <td>${u.id}</td>
                <td>${u.username}</td>
                <td>${u.email}</td>
                <td>${u.age ?? ""}</td>
                <td>${u.roles.join(", ")}</td>

                <td>
                    <button
                        class="btn btn-info btn-sm"
                        data-action="edit"
                        data-user='${JSON.stringify(u)}'>
                        Edit
                    </button>
                </td>

                <td>
                    <button
                        class="btn btn-danger btn-sm"
                        data-action="delete"
                        data-user='${JSON.stringify(u)}'>
                        Delete
                    </button>
                </td>
            `;

                tbody.appendChild(tr);
            });

        } catch (e) {
            console.error("Error loading users:", e);
        }
    }


    // ======================= CREATE USER =======================
    document.getElementById("new-user-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const form = e.target;

        const roles = [...document.getElementById("new-user-roles").selectedOptions]
            .map(o => o.value);

        const body = {
            username: form.username.value,
            email: form.email.value,
            age: form.age.value ? Number(form.age.value) : null,
            password: form.password.value,
            roles: roles
        };

        try {
            const res = await fetch(`${API}/users`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(body)
            });

            if (!res.ok) {
                alert("Ошибка при создании пользователя");
                return;
            }

            // ⬇️⬇️⬇️ ВАЖНО: ПЕРЕХОД В АДМИН-ПАНЕЛЬ ПОСЛЕ СОЗДАНИЯ
            window.location.href = "/admin";

        } catch (e) {
            console.error("Error creating user:", e);
            alert("Ошибка при создании пользователя");
        }
    });


    // ======================= OPEN EDIT / DELETE MODALS =======================
    document.getElementById("users-table-body").addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;

        const user = JSON.parse(btn.dataset.user);

        if (btn.dataset.action === "edit") {
            openEditModal(user);
        }

        if (btn.dataset.action === "delete") {
            openDeleteModal(user);
        }
    });


    // ======================= EDIT MODAL FILL =======================
    function openEditModal(user) {
        document.getElementById("edit-id").value = user.id;
        document.getElementById("edit-username").value = user.username;
        document.getElementById("edit-email").value = user.email;
        document.getElementById("edit-age").value = user.age ?? "";
        document.getElementById("edit-password").value = "";

        // выставляем роли
        const select = document.getElementById("edit-roles");
        [...select.options].forEach(opt => {
            opt.selected = user.roles.includes(opt.value);
        });

        new bootstrap.Modal(document.getElementById("editModal")).show();
    }


    // ======================= DELETE MODAL FILL =======================
    function openDeleteModal(user) {
        document.getElementById("delete-id").value = user.id;
        document.getElementById("delete-id-show").innerText = user.id;
        document.getElementById("delete-username").innerText = user.username;
        document.getElementById("delete-email").innerText = user.email;

        new bootstrap.Modal(document.getElementById("deleteModal")).show();
    }


    // ======================= UPDATE USER =======================
    document.getElementById("edit-user-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = document.getElementById("edit-id").value;

        const body = {
            id: Number(id),
            username: document.getElementById("edit-username").value,
            email: document.getElementById("edit-email").value,
            age: Number(document.getElementById("edit-age").value),
            password: document.getElementById("edit-password").value,
            roles: [...document.getElementById("edit-roles").selectedOptions]
                .map(o => o.value)
        };

        const res = await fetch(`${API}/users/${id}`, {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(body)
        });

        if (!res.ok) {
            alert("Ошибка обновления");
            return;
        }

        await loadUsers();
        bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
    });


    // ======================= DELETE USER =======================
    document.getElementById("delete-user-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = document.getElementById("delete-id").value;

        const res = await fetch(`${API}/users/${id}`, {
            method: "DELETE"
        });

        if (!res.ok) {
            alert("Ошибка удаления");
            return;
        }

        await loadUsers();
        bootstrap.Modal.getInstance(document.getElementById("deleteModal")).hide();
    });


    // ======================= INIT =======================
    document.addEventListener("DOMContentLoaded", async () => {
        await loadCurrentUser();
        await loadRoles();
        await loadUsers();
    });

</script>

</body>
</html>